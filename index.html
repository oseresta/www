<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Analysis Dashboard</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <style>
        html,body,h1,h2,h3,h4,h5 {font-family: "Roboto", sans-serif}
        .w3-bar-block .w3-bar-item {padding: 16px}
        
        /* Custom Styles */
        #main-content { margin-left: 260px; transition: margin-left .3s; }
        .nav-active { background-color: #2196F3 !important; color: white !important; }
        .hidden { display: none; }
        
        /* Table Styles */
        .analysis-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .analysis-table th, .analysis-table td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        .analysis-table th { background-color: #f1f1f1; cursor: pointer; }
        .analysis-table tr:hover { background-color: #f5f5f5; }
        
        /* Signal Colors */
        .signal-Buy { color: green; font-weight: bold; }
        .signal-Sell { color: red; font-weight: bold; }
        .signal-Hold { color: gray; }
        
        /* Gallery */
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(600px, 1fr)); gap: 20px; padding: 20px 0; }
        .gallery-item img { width: 100%; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        @media (max-width: 992px) {
            #main-content { margin-left: 0; }
            .w3-sidebar { display: none; z-index: 5; }
        }
        
        /* Loading Overlay */
        #loader {
            position: fixed; left: 0; top: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
        }
    </style>
</head>
<body class="w3-light-grey">

<!-- Top container -->
<div class="w3-bar w3-top w3-black w3-large" style="z-index:4">
  <button class="w3-bar-item w3-button w3-hide-large w3-hover-none w3-hover-text-light-grey" onclick="w3_open();"><i class="fa fa-bars"></i>  Menu</button>
  <span class="w3-bar-item w3-right">Stock Market Analysis</span>
  <button class="w3-bar-item w3-button w3-right w3-hover-none w3-hover-text-light-grey w3-hide-small" onclick="document.getElementById('subscribeModal').style.display='block'"><i class="fa fa-envelope"></i> Subscribe</button>
</div>

<!-- Sidebar/menu -->
<nav class="w3-sidebar w3-collapse w3-white w3-animate-left" style="z-index:3;width:260px;" id="mySidebar"><br>
  <div class="w3-container w3-row">
  </div>
  <hr>
  <div class="w3-container">
    <h5>Dashboard</h5>
  </div>
  <div class="w3-bar-block" id="nav-container">
    <a href="#" class="w3-bar-item w3-button w3-padding-16 w3-hide-large w3-dark-grey w3-hover-black" onclick="w3_close()" title="close menu"><i class="fa fa-remove fa-fw"></i>  Close Menu</a>
    <!-- Navigation will be populated here -->
  </div>
</nav>


<!-- Overlay effect when opening sidebar on small screens -->
<div class="w3-overlay w3-hide-large w3-animate-opacity" onclick="w3_close()" style="cursor:pointer" title="close side menu" id="myOverlay"></div>

<!-- !PAGE CONTENT! -->
<div class="w3-main" style="margin-left:300px;margin-top:43px;">

  <!-- Header -->
  <header class="w3-container" style="padding-top:22px">
    <h5><b><span id="page-title">Select a Strategy</span></b></h5>
  </header>

  <div id="dashboard-content" class="w3-container hidden">
      
      <div class="w3-panel w3-white w3-card w3-display-container">
          <p id="strategy-desc" class="w3-text-grey"></p>
      </div>

      <div class="w3-bar w3-black">
        <button class="w3-bar-item w3-button tablink w3-red" onclick="openTab(event,'Summary')">Summary</button>
        <button class="w3-bar-item w3-button tablink" id="btn-forward" onclick="openTab(event,'Forward')">Forward Testing</button>
        <button class="w3-bar-item w3-button tablink" id="btn-backward" onclick="openTab(event,'Backward')" style="display:none">Backward Testing</button>
      </div>
      
      <div id="Summary" class="w3-container tab-content w3-white w3-padding-16">
        <p>Loading data...</p>
      </div>

      <div id="Forward" class="w3-container tab-content w3-white w3-padding-16" style="display:none">
        <div id="gallery-forward" class="gallery-grid"></div>
      </div>

      <div id="Backward" class="w3-container tab-content w3-white w3-padding-16" style="display:none">
        <div id="gallery-backward" class="gallery-grid"></div>
      </div>
  </div>
  
  <div id="placeholder-msg" class="w3-container w3-padding-32 w3-center">
      <h3><i class="fa fa-arrow-left"></i> Reports are updated every day. Click a date (last 10 days) in the sidebar to view reports.</h3>
  </div>

  <!-- Footer -->
  <footer class="w3-container w3-padding-16 w3-light-grey">
    <p><a href="privacy.html">Privacy</a> | <a href="terms.html">Terms</a> | <a href="about.html">About</a> | <a href="contact.html">Contact</a></p>
  </footer>

  <!-- Subscribe Modal -->
  <div id="subscribeModal" class="w3-modal">
    <div class="w3-modal-content w3-animate-zoom w3-card-4" style="max-width:600px">
      <header class="w3-container w3-teal"> 
        <span onclick="document.getElementById('subscribeModal').style.display='none'" 
        class="w3-button w3-display-topright">&times;</span>
        <h2>Subscribe to Alerts</h2>
      </header>
      <div class="w3-container w3-padding-large">
        <p>Get notified when your favorite stocks trigger a Buy/Sell signal.</p>
        <div class="w3-panel w3-pale-yellow w3-border">
          <p><b>Note:</b> We use Google Forms to securely collect your preferences. Please fill out the form below.</p>
        </div>
        <!-- Placeholder for Google Form -->
        <div class="w3-center w3-padding-16" style="background:#f1f1f1; border: 1px solid #ddd;">
            <iframe src="https://docs.google.com/forms/d/e/1FAIpQLScd_IjFV5jOAmzE0RArcp-laGisCG-vnXnEV7k28cFQsleU5g/viewform?embedded=true" width="100%" height="500" frameborder="0" marginheight="0" marginwidth="0">Loadingâ€¦</iframe>
            <br>
            <p>Having trouble viewing the form?</p>
            <a href="https://docs.google.com/forms/d/e/1FAIpQLScd_IjFV5jOAmzE0RArcp-laGisCG-vnXnEV7k28cFQsleU5g/viewform?usp=sf_link" target="_blank" class="w3-button w3-black"><i class="fa fa-external-link"></i> Open in New Tab</a>
        </div>
      </div>
      <footer class="w3-container w3-teal w3-padding">
        <button class="w3-button w3-right w3-white w3-border" onclick="document.getElementById('subscribeModal').style.display='none'">Close</button>
      </footer>
    </div>
  </div>

  <!-- End page content -->
</div>

<script>
// Global Data
let manifest = {};

// Init
window.onload = async function() {
    try {
        const response = await fetch('manifest.json?v=' + new Date().getTime());
        manifest = await response.json();
        renderSidebar();
    } catch (e) {
        console.error("Failed to load manifest", e);
        document.getElementById("nav-container").innerHTML = "<div class='w3-padding w3-text-red'>Error loading data.</div>";
    }
};

// Sidebar Rendering
function renderSidebar() {
    const container = document.getElementById("nav-container");
    container.innerHTML = "";
    
    // Close button for mobile
    container.innerHTML += '<a href="#" class="w3-bar-item w3-button w3-padding-16 w3-hide-large w3-dark-grey w3-hover-black" onclick="w3_close()" title="close menu"><i class="fa fa-remove fa-fw"></i> Close Menu</a>';
    
    for (const [key, strategy] of Object.entries(manifest)) {
        if (!strategy.dates || strategy.dates.length === 0) continue;
        
        // Strategy Header (Accordion Trigger)
        const btn = document.createElement("button");
        btn.className = "w3-button w3-block w3-left-align w3-hover-light-grey";
        btn.innerHTML = `<i class="fa fa-line-chart fa-fw"></i> ${strategy.name} <i class="fa fa-caret-down"></i>`;
        
        const divId = `nav-${key}`;
        btn.onclick = () => myAccFunc(divId);
        
        container.appendChild(btn);
        
        // Dates Container
        const dateDiv = document.createElement("div");
        dateDiv.id = divId;
        dateDiv.className = "w3-hide w3-white w3-card-4";
        
        strategy.dates.forEach(item => {
            const link = document.createElement("a");
            link.href = "#";
            link.className = "w3-bar-item w3-button w3-padding-small";
            link.style.paddingLeft = "24px"; // Indent
            link.innerHTML = `<i class="fa fa-calendar fa-fw"></i> ${item.date}`;
            link.onclick = (e) => {
                e.preventDefault();
                loadReport(key, item);
                
                // Active state
                document.querySelectorAll(".w3-bar-item").forEach(el => el.classList.remove("nav-active"));
                link.classList.add("nav-active");
                
                // On mobile, close sidebar after selection
                w3_close();
            };
            dateDiv.appendChild(link);
        });
        
        container.appendChild(dateDiv);
    }
}

// Accordion
function myAccFunc(id) {
  var x = document.getElementById(id);
  if (x.className.indexOf("w3-show") == -1) {
    x.className += " w3-show";
    x.previousElementSibling.className += " w3-green";
  } else { 
    x.className = x.className.replace(" w3-show", "");
    x.previousElementSibling.className = 
    x.previousElementSibling.className.replace(" w3-green", "");
  }
}

// Toggle Sidebar
function w3_open() {
  var mySidebar = document.getElementById("mySidebar");
  var overlay = document.getElementById("myOverlay");
  if (mySidebar.style.display === 'block') {
    mySidebar.style.display = 'none';
    overlay.style.display = "none";
  } else {
    mySidebar.style.display = 'block';
    overlay.style.display = "block";
  }
}

function w3_close() {
  document.getElementById("mySidebar").style.display = "none";
  document.getElementById("myOverlay").style.display = "none";
}

// Tabs
function openTab(evt, tabName) {
  var i, x, tablinks;
  x = document.getElementsByClassName("tab-content");
  for (i = 0; i < x.length; i++) {
    x[i].style.display = "none";
  }
  tablinks = document.getElementsByClassName("tablink");
  for (i = 0; i < x.length; i++) {
    tablinks[i].className = tablinks[i].className.replace(" w3-red", "");
  }
  document.getElementById(tabName).style.display = "block";
  if(evt && evt.currentTarget) evt.currentTarget.className += " w3-red";
}

// Helper: Format JSON Table
function jsonToTable(data) {
    if (!data || data.length === 0) return "<p>No data available.</p>";
    
    // Columns to exclude
    const excluded = ["Model", "Strategy", "Best_Window", "Metric_Value", "Metric_Type", "Sentiment_Score", "timestamp"];
    
    // Get headers, filtering out excluded ones
    const allHeaders = Object.keys(data[0]);
    const headers = allHeaders.filter(h => !excluded.includes(h));
    
    let html = '<table class="analysis-table w3-table-all w3-hoverable">';
    html += '<thead><tr class="w3-light-grey">';
    headers.forEach(h => {
        // Replace underscores with spaces and Capitalize Each Word
        let displayHeader = h.replace(/_/g, " ").replace(/\b\w/g, l => l.toUpperCase());
        // Specific override for Ticker and Price
        if (h.toLowerCase() === 'ticker') displayHeader = "Ticker";
        if (h.toLowerCase() === 'current_price') displayHeader = "Current Price";
        // Specific override for RSI and MACD
        if (h.toLowerCase() === 'rsi') displayHeader = "RSI";
        if (h.toLowerCase() === 'macd') displayHeader = "MACD";
        if (h.toLowerCase() === 'mtf_trend') displayHeader = "MTF Trend";
        if (h.toLowerCase() === 'adx') displayHeader = "ADX";
        html += `<th>${displayHeader}</th>`;
    });
    html += '</tr></thead><tbody>';
    
    data.forEach(row => {
        html += '<tr>';
        headers.forEach(h => {
            let val = row[h];
            
            // Handle RSI object: show status only
            if (h.toLowerCase() === 'rsi' && val && typeof val === 'object' && val.status) {
                val = val.status;
            }
            
            // Handle MACD object: show crossover only
            if (h.toLowerCase() === 'macd' && val && typeof val === 'object' && val.crossover) {
                val = val.crossover;
            }
            
            // Handle Trend/MTF Trend object: show status only
            if ((h.toLowerCase() === 'trend' || h.toLowerCase() === 'mtf_trend') && val && typeof val === 'object' && val.status) {
                val = val.status;
            }
            
            // Handle ADX object: show status only
            if (h.toLowerCase() === 'adx' && val && typeof val === 'object' && val.status) {
                val = val.status;
            }
            
            // Handle Divergence object
            if (h.toLowerCase() === 'divergence' && val && typeof val === 'object') {
                if (val.bullish) val = "Bullish";
                else if (val.bearish) val = "Bearish";
                else val = "None";
            }
            
            // Handle Stops object
            if (h.toLowerCase() === 'stops' && val && typeof val === 'object') {
                const sl = val.stop_loss ? val.stop_loss.toFixed(2) : 'N/A';
                const tp = val.take_profit ? val.take_profit.toFixed(2) : 'N/A';
                val = `SL: ${sl} | TP: ${tp}`;
            }
            
            // Handle Arrays (e.g. Reasons): Join with comma
            if (Array.isArray(val)) {
                val = val.join(', ');
            }

            if (h === 'Signal' && val) {
                val = `<span class="signal-${val}">${val}</span>`;
            }
            if (val === null || val === undefined) val = "";
            
            // Check if object (and not handled above)
            if (typeof val === 'object') {
                val = JSON.stringify(val); // Fallback to avoid [object Object]
            }

            // Format numbers
            if (typeof val === 'number') {
                val = val.toFixed(2);
            }
            
            html += `<td>${val}</td>`;
        });
        html += '</tr>';
    });
    
    html += '</tbody></table>';
    return html;
}

// Load Content
async function loadReport(strategyKey, dateItem) {
    const strat = manifest[strategyKey];
    
    // UI Updates
    document.getElementById("placeholder-msg").classList.add("hidden");
    document.getElementById("dashboard-content").classList.remove("hidden");
    document.getElementById("page-title").innerText = `${strat.name} - ${dateItem.date}`;
    document.getElementById("strategy-desc").innerHTML = strat.description;
    
    // Toggle Tabs
    const btnForward = document.getElementById("btn-forward");
    const btnBackward = document.getElementById("btn-backward");

    if (strategyKey === 'pv') {
        btnForward.style.display = 'none';
        btnBackward.style.display = 'block';
    } else {
        btnForward.style.display = 'block';
        btnBackward.style.display = 'none';
    }
    
    // 1. Load Summary
    const summaryDiv = document.getElementById("Summary");
    if (dateItem.has_output && dateItem.output_file) {
        summaryDiv.innerHTML = '<p><i class="fa fa-spinner fa-spin"></i> Loading table...</p>';
        try {
            const res = await fetch(dateItem.output_file + '?v=' + new Date().getTime());
            const json = await res.json();
            // Handle array or single dict wrap
            const data = Array.isArray(json) ? json : [json];
            summaryDiv.innerHTML = jsonToTable(data);
        } catch(e) {
            summaryDiv.innerHTML = `<p class="w3-text-red">Error loading output data: ${e.message}</p>`;
        }
    } else {
        summaryDiv.innerHTML = "<p>No Summary Data found for this date.</p>";
    }
    
    // 2. Load Gallery (Forward or Backward)
    const galleryForward = document.getElementById("gallery-forward");
    galleryForward.innerHTML = "";
    const galleryBackward = document.getElementById("gallery-backward");
    galleryBackward.innerHTML = "";
    
    if (strategyKey === 'pv') {
        // Load Backward Images
        if (dateItem.backward_images && dateItem.backward_images.length > 0) {
            dateItem.backward_images.forEach(img => {
                const div = document.createElement("div");
                div.className = "gallery-item";
                // Get filename
                const imgName = img.split('/').pop();
                div.innerHTML = `<img src="${img}" alt="${imgName}" onclick="window.open(this.src)">`;
                galleryBackward.appendChild(div);
            });
        } else {
             galleryBackward.innerHTML = "<p>No backward testing plots found.</p>";
        }
    } else {
        // Load Forward Images
        if (dateItem.forward_images && dateItem.forward_images.length > 0) {
            dateItem.forward_images.forEach(img => {
                const div = document.createElement("div");
                div.className = "gallery-item";
                const imgName = img.split('/').pop();
                div.innerHTML = `<img src="${img}" alt="${imgName}" onclick="window.open(this.src)">`;
                galleryForward.appendChild(div);
            });
        } else {
            galleryForward.innerHTML = "<p>No forward testing plots found.</p>";
        }
    }
    
    // Reset to Summary Tab
    openTab(null, 'Summary');
    // Set active tab color manually since we passed null event
    document.querySelectorAll(".tablink").forEach(el => el.classList.remove("w3-red"));
    document.querySelector(".tablink").classList.add("w3-red"); 
}
</script>

</body>
</html>
